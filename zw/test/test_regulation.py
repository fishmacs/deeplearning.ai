import numpy as np
from numpy.testing import assert_allclose as assert_eq
from nose import tools as nt
from zw.neuralnetwork import NeuralNetwork

np.set_printoptions(precision=10)


def test_backward_propagation():
    np.random.seed(1)
    x = np.random.randn(3, 5)
    y = np.array([[1, 1, 0, 1, 0]])

    w1 = np.array([
        [-1.09989127, -0.17242821, -0.87785842],
        [0.04221375, 0.58281521, -1.10061918]
    ])
    b1 = np.array([[1.14472371], [0.90159072]])

    w2 = np.array([
        [0.50249434, 0.90085595],
        [-0.68372786, -0.12289023],
        [-0.93576943, -0.26788808]
    ])
    b2 = np.array([[0.53035547], [-0.69166075], [-0.39675353]])

    w3 = np.array([[-0.6871727, -0.84520564, -0.67124613]])
    b3 = np.array([[-0.0126646]])

    z1 = np.array([
        [-1.52855314, 3.32524635, 2.13994541, 2.60700654, -0.75942115],
        [-1.98043538, 4.1600994, 0.79051021, 1.46493512, -0.45506242]
    ])
    a1 = np.array([
        [0., 3.32524635, 2.13994541, 2.60700654, 0.],
        [0., 4.1600994, 0.79051021, 1.46493512, 0.]
    ])

    z2 = np.array([
        [0.53035547, 5.94892323, 2.31780174, 3.16005701, 0.53035547],
        [-0.69166075, -3.47645987, -2.25194702, -2.65416996, -0.69166075],
        [-0.39675353, -4.62285846, -2.61101729, -3.22874921, -0.39675353]
    ])
    a2 = np.array([
        [0.53035547, 5.94892323, 2.31780174, 3.16005701, 0.53035547],
        [0., 0., 0., 0., 0.],
        [0., 0., 0., 0., 0.]
    ])

    z3 = np.array([[-0.3771104, -4.10060224, -1.60539468, -2.18416951, -0.3771104]])
    a3 = np.array([[0.40682402, 0.01629284, 0.16722898, 0.10118111, 0.40682402]])

    nn = NeuralNetwork(w=[w1, w2, w3], b=[b1, b2, b3], lambd=0.7)
    nn.cache = [(x, z1), (a1, z2), (a2, z3)]
    gradw, gradb = nn.model_backward(a3, y)

    assert_eq(gradw[0], [
        [-0.256046467, 0.122988299, -0.28297132],
        [-0.17706304, 0.34536100, -0.4410572]
    ], rtol=1e-5)
    assert_eq(gradw[1], [
        [0.792764876, 0.85133918],
        [-0.0957219, -0.01720463],
        [-0.13100772, -0.03750433]
    ], rtol=1e-5)
    assert_eq(gradw[2], [[-1.77691347, -0.11832879, -0.09397446]], rtol=1e-5)
